# Введение

## Что это?

shop-app-backend — мой pet-project, представляющий собой backend-часть интернет-магазина одежды.

## А зачем?

<ul>
<li>Для получения опыта <s>какой-никакой</s> энтерпрайз-разработки;</li>
<li>Для изучения инструментов и технологий в рамках уже существующего решения;</li>
<li>Для возможности иметь проект, 
    с которым можно проводить любые манипуляции и не иметь проблем с совестью;</li>
<li><s>Для включения в резюме.</s></li>
</ul>

## Концепция

За основу взята идея создания интернет-магазина одежды. Функционал приложения должен позволять:
<ul>
<li>получать информацию о текущем ассортименте магазина;</li>
<li>формировать заказы на покупку;</li>
<li>управлять складскими запасами ассортимента.</li>
</ul>
Начиная с версии `v1.4.0` приложение является мультиконтейнерным, т. е. состоящим из нескольких приложений. Все они объединяются через общий `docker-compose` файл.

Компоненты:

- основное приложение (вы сейчас в его репозитории);
- приложение по доставке заказов (оно [здесь](https://github.com/nikjags/delivery-app));
- ActiveMQ-брокер, использующийся для обмена сообщениями между приложениями выше.

# Как попробовать?

Доступны два варианта приложения:

1. standalone-приложение без JMS и механики доставки заказов;
2. приложение целиком через docker-compose.

## Standalone

Можно получить через докер или архив.

### Образ Docker

Репозиторий с образом приложения: `nikjag/shop-app-backend`. 

Чтобы создать контейнер: 

```docker
docker run -dp 8080:8080 --name shop-app-backend nikjag/shop-app-backend:version-*версия*
```
`*версия*` -- какая-либо версия проекта.

Например, для версии `1.3.0`:

```docker
docker run -dp 8080:8080 --name shop-app-backend nikjag/shop-app-backend:version-1.3.0
```

### Архив

Архив с собранным проектом [здесь](https://github.com/nikjags/Shop-app-backend/releases/latest). Для запуска нужна Java версии 8 и выше.

В файле со скачанным проектом открыть командную строку и ввести `java -jar название_архива`.

Остановка работы приложения:
<ul>
<li>Для сторонников светлой силы: вбить в браузер 
    <code>http://localhost:8080/shop/api/app/shutdown</code>;</li>
<li>Для тех, кому дорого время: закрыть окно консоли с приложением.</li>
</ul>
### Замечания при использовании standalone приложения

Так как JMS-брокер и стороннее приложение в данном варианте недоступны, то при использовании будут выскакивать следующие ошибки:

- при запуске приложения: несколько раз `JmsListener` предпримет попытки соединиться со сторонней очередью и будет выдавать ошибки при неудаче;
- при формировании нового заказа: внутренний сервис предпримет попытку отправить в несуществующую очередь информацию о заказе для его доставке. Информация о новом заказе сохранена не будет.

В общем, лучше, конечно, получать приложение целиком.

## Приложение целиком через docker-compose

Подразумевается, что у вас уже есть Docker.

1. Скачать `docker-compose.yml` [здесь](https://github.com/nikjags/Shop-app-backend/releases/latest);

2. в папке со скачанным файлом выполнить:

   ```
   docker-compose -f docker-compose.yml -p shop-app up --build
   ```

В итоге разворачиваются три контейнера с базовым приложением, JMS-брокером и приложением для доставки заказов.

# Внутренности backend-проекта

Backend-часть представляет собой небольшое приложение, созданное на Spring Boot, основной целью которого является обработка запросов на получение, сохранение и
удаление данных.

## Устройство бэкенда

Общая схема приложения:

<img src="src/main/resources/docs/backend_scheme.png" width="500">

### Repositories

Отвечают за доступ к БД и реализуют базовые CRUD-операции. Является поставщиком функционала для сервисов.

У каждой ORM-сущности (см. ниже) собственный репозиторий.

Код репозиториев расположен в `src/main/java/ru/study/shop/adapters/hibernate`.

### Services

Являются промежуточным уровнем между БД и потребителями данных. Предоставляют основной функционал для доступа к данным внутри бэкенда. Расширяют функционал
работы с БД; методы сервисов отвечают за выполнение и откат транзакций.

Каждый сервис отвечает за доступ к данным одной сущности. Например, `OrderService` предоставляет методы для работы с сущностью Order.

Код интерфейсов расположен в `src/main/java/ru/study/shop/services/interfaces`, имплементаций: `src/main/java/ru/study/shop/services/impl`.

### Controllers

Связывают backend-часть с frontend-частью или сторонними приложениями. Предоставляют API для доступа к данным извне.

В данный момент предоставляемый API не является RESTful, по сути своей является RPC
(подробности [здесь](https://roy.gbiv.com/untangled/2008/rest-apis-must-be-hypertext-driven)).

API контроллеров можно посмотреть через Swagger при запуске приложения:

```
localhost:8080/shop/api/swagger-ui.html
```

Можно также получить JSON с OpenAPI v3 схемой:

```
localhost:8080/shop/api/v3/api-docs/
```

## Схема базы данных

Схема БД:

<img src="src/main/resources/docs/DB_structure.png" width="800">

|   Отношение    |                                 Описание                                 |
| -------------- | ------------------------------------------------------------------------ |
| product        | Содержит данные о всём ассортименте магазина;                            |
| order          | Содержит данные о всех заказах, совершённых в магазине;                  |
| orders_product | Промежуточная таблица, содержащая все заказанные товары и их количество; |
| stock          | Содержит даннные о текущих запасах в магазине;                           |
| customer       | Содержит информацию о покупателях;                                       |

Простая таблица, удовлетворяющая потребности в хранении данных внутри приложения.

В качестве БД для хранения данных выбрана H2 -- опенсорсная in-memory БД с возможностью доступа через консоль в браузере.

Наполнение БД производится через flyway -- систему контроля версий для баз данных. Скрипты миграции расположены в `src/main/resources/db/migration`.

## Схема ORM-сущностей

В качестве ORM-фреймворка используется Hibernate.

Схема сущностей:

<img src="src/main/resources/docs/Entities.png" width="800">

# P.S.

А frontend будет ближе к выходным.